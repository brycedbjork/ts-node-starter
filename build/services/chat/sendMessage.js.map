{"version":3,"sources":["../../../src/services/chat/sendMessage.ts"],"names":["sendMessage","uid","chatId","text","userData","chatData","hirer","id","users","active","Error","message","type","from","firstName","image","time","unix","date","format","firestore","collection","doc","add","lastMessage","readBy","sendToUsers","Object","keys","req","res","body","status","send","console","log","Sentry","captureException"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;AAEA,IAAMA,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,iBAAOC,GAAP,EAAoBC,MAApB,EAAoCC,IAApC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACK,sBAAQF,GAAR,EAAa,IAAb,CADL;;AAAA;AACZG,YAAAA,QADY;AAAA;AAAA,mBAEK,sBAAQF,MAAR,CAFL;;AAAA;AAEZG,YAAAA,QAFY;;AAAA,kBAGdA,QAAQ,CAACC,KAAT,CAAeC,EAAf,IAAqBN,GAArB,IAA4BI,QAAQ,CAACG,KAAT,CAAeP,GAAf,EAAoBQ,MAApB,IAA8B,IAH5C;AAAA;AAAA;AAAA;;AAAA,kBAKV,IAAIC,KAAJ,CAAU,wCAAV,CALU;;AAAA;AAQlB;AACMC,YAAAA,OATY,GASO;AACvBC,cAAAA,IAAI,EAAE,MADiB;AAEvBC,cAAAA,IAAI,EAAE;AACJN,gBAAAA,EAAE,EAAEN,GADA;AAEJa,gBAAAA,SAAS,EAAEV,QAAQ,CAACU,SAFhB;AAGJC,gBAAAA,KAAK,EAAEX,QAAQ,CAACW;AAHZ,eAFiB;AAOvBZ,cAAAA,IAAI,EAAJA,IAPuB;AAQvBa,cAAAA,IAAI,EAAE,0BAASC,IAAT,EARiB;AASvBC,cAAAA,IAAI,EAAE,0BAASC,MAAT;AATiB,aATP,EAqBlB;;AArBkB;AAAA,mBAsBZC,oBACHC,UADG,CACQ,OADR,EAEHC,GAFG,CAECpB,MAFD,EAGHmB,UAHG,CAGQ,UAHR,EAIHE,GAJG,CAICZ,OAJD,CAtBY;;AAAA;AAAA;AAAA,mBA6BZ,4BAAWT,MAAX,EAAmB;AACvBsB,cAAAA,WAAW,EAAEb,OADU;AAEvBc,cAAAA,MAAM,sBACHxB,GADG,EACG,IADH;AAFiB,aAAnB,CA7BY;;AAAA;AAoClB;AACMyB,YAAAA,WArCY,GAqCYC,MAAM,CAACC,IAAP,CAAYvB,QAAQ,CAACG,KAArB,CArCZ;AAAA;AAAA,mBAsCZ,kCAAiBP,GAAjB,EAAsBG,QAAtB,EAAgCsB,WAAhC,EAA6CvB,IAA7C,EAAmDD,MAAnD,CAtCY;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAXF,WAAW;AAAA;AAAA;AAAA,GAAjB;;;;;;;0BAyCe,kBAAO6B,GAAP,EAAiBC,GAAjB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wBAMwCD,GAAG,CAACE,IAN5C,EAGT9B,GAHS,aAGTA,GAHS,EAITC,MAJS,aAITA,MAJS,EAKTC,IALS,aAKTA,IALS;AAAA;AAAA,mBAQLH,WAAW,CAACC,GAAD,EAAMC,MAAN,EAAcC,IAAd,CARN;;AAAA;AAAA,8CAUJ2B,GAAG,CAACE,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,EAVI;;AAAA;AAAA;AAAA;AAYXH,YAAAA,GAAG,CAACE,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,kBAArB;AACAC,YAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ;AACAC,YAAAA,MAAM,CAACC,gBAAP;;AAdW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import { auth, firestore, messaging } from \"../../firebase\";\nimport * as Sentry from \"@sentry/node\";\nimport { Chat, Message } from \"../../schemas/Chat\";\nimport { getUser } from \"../user/getUser\";\nimport { updateChat } from \"../chat/updateChat\";\nimport { getChat } from \"../chat/getChat\";\nimport moment from \"moment\";\nimport chatNotification from \"../notification/chatNotification\";\n\nconst sendMessage = async (uid: string, chatId: string, text: string) => {\n  const userData = await getUser(uid, null);\n  const chatData = await getChat(chatId);\n  if (chatData.hirer.id != uid && chatData.users[uid].active != true) {\n    // user cannot send message into this chat\n    throw new Error(\"user does not have access to this chat\");\n  }\n\n  // construct message\n  const message: Message = {\n    type: \"text\",\n    from: {\n      id: uid,\n      firstName: userData.firstName,\n      image: userData.image\n    },\n    text,\n    time: moment().unix(),\n    date: moment().format()\n  };\n\n  // add message to messages subcollection of chat\n  await firestore\n    .collection(\"chats\")\n    .doc(chatId)\n    .collection(\"messages\")\n    .add(message);\n\n  // update chat's last message\n  await updateChat(chatId, {\n    lastMessage: message,\n    readBy: {\n      [uid]: true\n    }\n  });\n\n  // notify\n  const sendToUsers: string[] = Object.keys(chatData.users);\n  await chatNotification(uid, userData, sendToUsers, text, chatId);\n};\n\nexport default async (req: any, res: any) => {\n  try {\n    const {\n      uid,\n      chatId,\n      text\n    }: { uid: string; text: string; chatId: string } = req.body;\n\n    await sendMessage(uid, chatId, text);\n\n    return res.status(200).send();\n  } catch (error) {\n    res.status(500).send(\"Something broke!\");\n    console.log(\"Error: \" + error);\n    Sentry.captureException(error);\n  }\n};\n"],"file":"sendMessage.js"}